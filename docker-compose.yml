---
version: "3"

volumes:
  ipfs:

services:
  postgres-linker:
    container_name: postgres-linker
    restart: always
    image: postgres:10.0
    environment:
      - POSTGRES_USER=origin
      - POSTGRES_PASSWORD=origin
      - POSTGRES_DB=origin
    ports:
      - "5432:5432"

  redis-master-linker:
    container_name: redis-master-linker
    image: 'bitnami/redis:latest'
    environment:
      - ALLOW_EMPTY_PASSWORD=yes
    ports:
      - '6379:6379'
    command: /run.sh --maxmemory 100mb


  services-linker:
    container_name: services-linker
    image: origin-linker
    build:
      context: .
      dockerfile: Dockerfile
    volumes: &volumes
      - ./lerna.json:/app/lerna.json
      # Mount source code for all packages from host
      - ./packages/contracts/build:/app/packages/contracts/build
      # Core packages
      - ./packages/services/:/app/packages/services/
      - ./packages/graphql/:/app/packages/graphql/
      - ./packages/eventsource/:/app/packages/eventsource/
      - ./packages/ipfs/:/app/packages/ipfs/
      - ./packages/messaging-client/:/app/packages/messaging-client/
      - ./packages/linker-client/:/app/packages/linker-client/
      - ./packages/validator:/app/packages/validator/
      - ./packages/token/:/app/packages/token/
      - ./packages/origin-js/:/app/packages/origin-js/
      # Infrastructure packages
      - ./infra/bridge/:/app/infra/bridge/
      - ./infra/discovery/:/app/infra/discovery/
      - ./infra/ipfs-proxy/:/app/infra/ipfs-proxy/
      - ./infra/messaging/:/app/infra/messaging/
      - ./infra/notifications/:/app/infra/notifications/
      - ./infra/growth/:/app/infra/growth/
      - ./infra/identity/:/app/infra/identity/
      - ./infra/linking/:/app/infra/linking/
      # Exclude all node_modules from the host
      - /app/packages/services/node_modules/
      - /app/packages/graphql/node_modules/
      - /app/packages/eventsource/node_modules/
      - /app/packages/ipfs/node_modules/
      - /app/packages/messaging-client/node_modules/
      - /app/packages/linker-client/node_modules/
      - /app/packages/validator/node_modules/
      - /app/packages/token/node_modules/
      - /app/packages/origin-js/node_modules/
      - /app/infra/bridge/node_modules/
      - /app/infra/discovery/node_modules/
      - /app/infra/ipfs-proxy/node_modules/
      - /app/infra/messaging/node_modules/
      - /app/infra/notifications/node_modules/
      - /app/infra/growth/node_modules/
      - /app/infra/identity/node_modules/
      - /app/infra/linking/node_modules/
      # IPFS data
      - ipfs:/app/ipfs
    ports:
      # IPFS ports are exposed here for convenience but IPFS should be
      # interacted with via ipfs-proxy
      - "5002:5002"
      - "8080:8080"
      - "8545:8545"
    environment:
      - DOCKER=true
      - DEPLOY_CONTRACTS=true
    command: npm run start --prefix packages/services

  ipfs-proxy-linker:
    container_name: ipfs-proxy-linker
    image: origin-linker
    volumes: *volumes
    ports:
      - "9999:9999"
    environment:
      - IPFS_API_URL=http://services-linker:5002
      - IPFS_GATEWAY_URL=http://services-linker:8080
    command: npm run start --prefix infra/ipfs-proxy

  linking-linker:
    container_name: linking-linker
    image: origin-linker
    volumes: *volumes
    environment:
      - HOT_WALLET_PK=C87509A1C067BBDE78BEB793E6FA76530B6382A4C0241E5E4A9EC0A0F44DC0D3
      - ATTESTATION_ACCOUNT=0x99C03fBb0C995ff1160133A8bd210D0E77bCD101
      - DAPP_URL=http://localhost:3000
      - DATABASE_URL=postgres://origin:origin@postgres-linker/origin
      - DISCOVERY_SERVER_URL=http://localhost:4000
      - PROVIDER_URL=http://localhost:8545
      - REDIS_URL=redis://redis-master-linker:6379
      - ENVKEY=
    depends_on:
      - postgres-linker
      - redis-master-linker
    ports:
      - "3008:3008"
    command:
      >
      /bin/bash -c "wait-for.sh -t 0 -q postgres-linker:5432 --
      npm run migrate --prefix infra/linking &&
      npm run start --prefix infra/linking"
